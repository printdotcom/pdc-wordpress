#!/usr/bin/env bash

# Seed script to configure WooCommerce and create products using raw SQL
set -e

CONFIG_FILE="config/wp-version.conf"

WORDPRESS_VERSION_ENV="${1:-$WORDPRESS_VERSION}"
PHP_VERSION_ENV="${2:-$PHP_VERSION}"

# Use defaults if no arguments provided
if [[ -z "$WORDPRESS_VERSION_ENV" ]]; then
    WORDPRESS_VERSION_ENV="67"
fi

if [[ -z "$PHP_VERSION_ENV" ]]; then
    PHP_VERSION_ENV="82"
fi

WP_IMAGE_KEY="${WORDPRESS_VERSION_ENV}_${PHP_VERSION_ENV}"
WP_IMAGE=$(grep "^${WP_IMAGE_KEY}=" "$CONFIG_FILE" | cut -d'=' -f2)
WORDPRESS_PORT="80${WORDPRESS_VERSION_ENV}"

if [ -z "$WP_IMAGE" ]; then
  echo "‚ùå Unsupported version combination: $WP_IMAGE_KEY"
  echo "Available combinations in $CONFIG_FILE:"
  grep "^[0-9]" "$CONFIG_FILE" || echo "No valid combinations found"
  exit 1
fi

# Parse WordPress version parameter
if [[ "$WORDPRESS_VERSION_ENV" =~ ^[0-9]{2}$ ]]; then
  WORDPRESS_VERSION="${WORDPRESS_VERSION_ENV:0:1}.${WORDPRESS_VERSION_ENV:1:1}"
else
  WORDPRESS_VERSION="$WORDPRESS_VERSION_ENV"
fi

# Parse PHP version parameter  
if [[ "$PHP_VERSION_ENV" =~ ^[0-9]{2}$ ]]; then
  PHP_VERSION="${PHP_VERSION_ENV:0:1}.${PHP_VERSION_ENV:1:1}"
else
  PHP_VERSION="$PHP_VERSION_ENV"
fi

export WORDPRESS_VERSION 
export WORDPRESS_VERSION_ENV
export WP_IMAGE
export PHP_VERSION
export PHP_VERSION_ENV
export WORDPRESS_PORT
export COMPOSE_PROJECT_NAME="pdc_${WORDPRESS_VERSION_ENV}_${PHP_VERSION_ENV}"

# Execute SQL commands via WP-CLI
execute_sql() {
    local SQL="$1"
    echo "Executing SQL: ${SQL:0:100}..."
    docker compose -f config/docker-compose.yml run --rm wpcli wp db query "$SQL" --allow-root
}

execute_wp_cli() {
    docker compose -f config/docker-compose.yml run --rm wpcli wp "$@" --allow-root
}

# Resetting environment
execute_wp_cli db reset --yes

docker compose -f config/docker-compose.yml run --rm --user root --no-TTY --env WORDPRESS_PORT --env WORDPRESS_VERSION wpcli bash <<EOF
set -e

if [ ! -f wp-load.php ]; then
  echo "Downloading WordPress \${WORDPRESS_VERSION}..."
  TMP=\$(mktemp -d)
  curl -fsSL "http://wordpress.org/wordpress-\${WORDPRESS_VERSION}.tar.gz" | tar -xz -C "\$TMP"
  cp -R "\$TMP"/wordpress/* .
  rm -rf "\$TMP"
fi

if [ ! -f wp-config.php ]; then
  wp config create --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --dbhost=db --allow-root --skip-salts
fi

until wp db check --allow-root; do
  echo "DB not ready yet.."
  sleep 2
done

wp db create --allow-root 2>/dev/null || true

if ! wp core is-installed --allow-root; then
  wp core install \
    --url=http://localhost:${WORDPRESS_PORT} \
    --title='My Site' \
    --admin_user=admin \
    --admin_password=password \
    --admin_email=wordpress@example.com \
    --skip-email \
    --allow-root
  chown -R 33:33 wp-content/uploads/
else
  echo "WordPress already installed."
fi
EOF

# Activating Plugins
execute_wp_cli plugin activate woocommerce pdc-pod

# Clean up existing content
echo "üßπ Cleaning up existing content..."
execute_sql "
DELETE FROM wp_posts WHERE post_type IN ('product', 'product_variation', 'page', 'post');
DELETE FROM wp_postmeta WHERE post_id NOT IN (SELECT ID FROM wp_posts);
DELETE FROM wp_term_relationships WHERE object_id NOT IN (SELECT ID FROM wp_posts);
DELETE t, tt FROM wp_terms t JOIN wp_term_taxonomy tt ON t.term_id = tt.term_id WHERE tt.taxonomy IN ('product_cat', 'product_tag', 'pa_size');
"

# Configure WooCommerce settings via SQL
echo "‚öôÔ∏è Configuring WooCommerce..."
execute_sql "
INSERT INTO wp_options (option_name, option_value, autoload) VALUES
('woocommerce_store_address', '123 Example Street', 'yes'),
('woocommerce_store_city', 'Example City', 'yes'),
('woocommerce_default_country', 'US:CA', 'yes'),
('woocommerce_store_postcode', '90210', 'yes'),
('woocommerce_currency', 'USD', 'yes'),
('woocommerce_product_type', 'both', 'yes'),
('woocommerce_allow_tracking', 'no', 'yes'),
('woocommerce_enable_guest_checkout', 'yes', 'yes'),
('woocommerce_enable_checkout_login_reminder', 'yes', 'yes'),
('woocommerce_enable_signup_and_login_from_checkout', 'yes', 'yes'),
('woocommerce_enable_myaccount_registration', 'yes', 'yes'),
('woocommerce_registration_generate_username', 'yes', 'yes'),
('woocommerce_registration_generate_password', 'yes', 'yes')
ON DUPLICATE KEY UPDATE option_value = VALUES(option_value);"

# Create WooCommerce pages
echo "üìÑ Creating WooCommerce pages..."
execute_sql "
-- Create Shop page
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, menu_order, post_type, post_mime_type, comment_count)
VALUES (1, NOW(), UTC_TIMESTAMP(), '[woocommerce_shop]', 'Shop', '', 'publish', 'closed', 'closed', '', 'shop', '', '', NOW(), UTC_TIMESTAMP(), '', 0, 0, 'page', '', 0);

SET @shop_page_id = LAST_INSERT_ID();

-- Create Cart page
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, menu_order, post_type, post_mime_type, comment_count)
VALUES (1, NOW(), UTC_TIMESTAMP(), '[woocommerce_cart]', 'Cart', '', 'publish', 'closed', 'closed', '', 'cart', '', '', NOW(), UTC_TIMESTAMP(), '', 0, 0, 'page', '', 0);

SET @cart_page_id = LAST_INSERT_ID();

-- Create Checkout page
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, menu_order, post_type, post_mime_type, comment_count)
VALUES (1, NOW(), UTC_TIMESTAMP(), '[woocommerce_checkout]', 'Checkout', '', 'publish', 'closed', 'closed', '', 'checkout', '', '', NOW(), UTC_TIMESTAMP(), '', 0, 0, 'page', '', 0);

SET @checkout_page_id = LAST_INSERT_ID();

-- Create My Account page
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, menu_order, post_type, post_mime_type, comment_count)
VALUES (1, NOW(), UTC_TIMESTAMP(), '[woocommerce_my_account]', 'My account', '', 'publish', 'closed', 'closed', '', 'my-account', '', '', NOW(), UTC_TIMESTAMP(), '', 0, 0, 'page', '', 0);

SET @account_page_id = LAST_INSERT_ID();

-- Set WooCommerce page options
INSERT INTO wp_options (option_name, option_value, autoload) VALUES
('woocommerce_shop_page_id', @shop_page_id, 'yes'),
('woocommerce_cart_page_id', @cart_page_id, 'yes'),
('woocommerce_checkout_page_id', @checkout_page_id, 'yes'),
('woocommerce_myaccount_page_id', @account_page_id, 'yes')
ON DUPLICATE KEY UPDATE option_value = VALUES(option_value);"

# Create product categories
echo "üè∑Ô∏è Creating product categories..."
execute_sql "
-- Create Print Products category
INSERT INTO wp_terms (name, slug, term_group) VALUES ('Print Products', 'print-products', 0);
SET @print_products_term_id = LAST_INSERT_ID();

INSERT INTO wp_term_taxonomy (term_id, taxonomy, description, parent, count) 
VALUES (@print_products_term_id, 'product_cat', 'Custom print products from Print.com', 0, 0);
SET @print_products_taxonomy_id = LAST_INSERT_ID();

-- Create T-Shirts subcategory
INSERT INTO wp_terms (name, slug, term_group) VALUES ('T-Shirts', 't-shirts', 0);
SET @tshirts_term_id = LAST_INSERT_ID();

INSERT INTO wp_term_taxonomy (term_id, taxonomy, description, parent, count) 
VALUES (@tshirts_term_id, 'product_cat', 'Custom printed t-shirts', @print_products_taxonomy_id, 0);
SET @tshirts_taxonomy_id = LAST_INSERT_ID();

-- Create Posters subcategory
INSERT INTO wp_terms (name, slug, term_group) VALUES ('Posters', 'posters', 0);
SET @posters_term_id = LAST_INSERT_ID();

INSERT INTO wp_term_taxonomy (term_id, taxonomy, description, parent, count) 
VALUES (@posters_term_id, 'product_cat', 'Custom printed posters', @print_products_taxonomy_id, 0);
SET @posters_taxonomy_id = LAST_INSERT_ID();"

# Function to create a product using SQL
create_product_sql() {
    local SKU="$1"
    local TITLE="$2"
    local PRICE="$3"
    local DESCRIPTION="$4"
    local CATEGORY_SLUG="$5"
    
    echo "üõçÔ∏è Creating product: $TITLE (SKU: $SKU)"
    
    execute_sql "
    -- Create the product post
    INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_content, post_title, post_excerpt, post_status, comment_status, ping_status, post_password, post_name, to_ping, pinged, post_modified, post_modified_gmt, post_content_filtered, post_parent, menu_order, post_type, post_mime_type, comment_count)
    VALUES (1, NOW(), UTC_TIMESTAMP(), '$DESCRIPTION', '$TITLE', '', 'publish', 'closed', 'closed', '', '$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')', '', '', NOW(), UTC_TIMESTAMP(), '', 0, 0, 'product', '', 0);
    
    SET @product_id = LAST_INSERT_ID();
    
    -- Add product meta data
    INSERT INTO wp_postmeta (post_id, meta_key, meta_value) VALUES
    (@product_id, '_sku', '$SKU'),
    (@product_id, '_price', '$PRICE'),
    (@product_id, '_regular_price', '$PRICE'),
    (@product_id, '_sale_price', ''),
    (@product_id, '_visibility', 'visible'),
    (@product_id, '_stock_status', 'instock'),
    (@product_id, '_manage_stock', 'no'),
    (@product_id, '_sold_individually', 'no'),
    (@product_id, '_virtual', 'no'),
    (@product_id, '_downloadable', 'no'),
    (@product_id, '_product_attributes', ''),
    (@product_id, '_default_attributes', ''),
    (@product_id, '_featured', 'no'),
    (@product_id, '_weight', ''),
    (@product_id, '_length', ''),
    (@product_id, '_width', ''),
    (@product_id, '_height', ''),
    (@product_id, '_tax_status', 'taxable'),
    (@product_id, '_tax_class', ''),
    (@product_id, '_purchase_note', ''),
    (@product_id, '_product_version', '8.5.0');
    
    -- Assign to category
    INSERT INTO wp_term_relationships (object_id, term_taxonomy_id, term_order)
    SELECT @product_id, tt.term_taxonomy_id, 0
    FROM wp_term_taxonomy tt
    JOIN wp_terms t ON tt.term_id = t.term_id
    WHERE t.slug = '$CATEGORY_SLUG' AND tt.taxonomy = 'product_cat';
    
    -- Update category count
    UPDATE wp_term_taxonomy tt
    JOIN wp_terms t ON tt.term_id = t.term_id
    SET tt.count = tt.count + 1
    WHERE t.slug = '$CATEGORY_SLUG' AND tt.taxonomy = 'product_cat';
    "
}

# Adding shipping zones and payment methods using WP-CLI
echo "üöö Setting up shipping zones and methods..."
US_ZONE_ID=$(execute_wp_cli wc shipping_zone create --name='United States' --order=0 --porcelain --user=1)
execute_wp_cli wc shipping_zone_method create $US_ZONE_ID --method_id=flat_rate --enabled=true --user=1 --settings='{\"title\":\"Flat rate\",\"cost\":\"5.99\"}'
ROW_ZONE_ID=$(execute_wp_cli wc shipping_zone create --name='Rest of World' --order=1 --porcelain --user=1)
execute_wp_cli wc shipping_zone_method create $ROW_ZONE_ID --method_id=flat_rate --enabled=true --user=1 --settings='{\"title\":\"Flat rate\",\"cost\":\"15.99\"}'

echo "üí∞ Configuring payment methods..."
execute_wp_cli wc payment_gateway update cod --enabled=true --user=1 --settings='{\"title\":\"Cash on delivery\",\"description\":\"Pay with cash upon delivery.\",\"instructions\":\"Pay with cash upon delivery.\",\"enable_for_virtual\":\"yes\"}'
execute_wp_cli option update woocommerce_default_gateway cod

# Create sample products
echo "üé® Creating simple product..."
create_product_sql "PDC-FLYERS-001" "Custom Flyers" "14.99" "Personalized flyers with your custom design." "print-products"

echo "üõçÔ∏è Creating variable product: Custom Poster"

# Create Size attribute
execute_wp_cli wc product_attribute create --name="Size" --slug="size" --type="select" --user=1 --porcelain 2>/dev/null || echo "Attribute exists"

# Create attribute terms
execute_wp_cli term create pa_size "A2" --slug=a2
execute_wp_cli term create pa_size "A3" --slug=a3

# Get poster category ID
POSTER_CAT_ID=$(execute_wp_cli term list product_cat --slug=posters --field=term_id --format=ids)

# Create variable product with WP-CLI
PRODUCT_ID=$(execute_wp_cli post create --post_type=product --post_title="Custom Poster" --post_content="High-resolution custom printed poster. Available in A2 and A3 sizes." --post_status=publish --porcelain)

# Set product metadata and attributes using SQL
execute_sql "
SET @product_id = $PRODUCT_ID;
SET @poster_cat_id = $POSTER_CAT_ID;

-- Set product meta
INSERT INTO wp_postmeta (post_id, meta_key, meta_value) VALUES
(@product_id, '_sku', 'PDC-POSTER'),
(@product_id, '_stock_status', 'instock'),
(@product_id, '_manage_stock', 'no'),
(@product_id, '_product_attributes', 'a:1:{s:7:\"pa_size\";a:6:{s:4:\"name\";s:7:\"pa_size\";s:5:\"value\";s:0:\"\";s:8:\"position\";i:0;s:10:\"is_visible\";i:1;s:12:\"is_variation\";i:1;s:11:\"is_taxonomy\";i:1;}}');

-- Link to variable product type and category
INSERT INTO wp_term_relationships (object_id, term_taxonomy_id) 
SELECT @product_id, term_taxonomy_id FROM wp_term_taxonomy WHERE taxonomy='product_type' AND term_id=(SELECT term_id FROM wp_terms WHERE slug='variable');

INSERT INTO wp_term_relationships (object_id, term_taxonomy_id)
SELECT @product_id, term_taxonomy_id FROM wp_term_taxonomy WHERE taxonomy='product_cat' AND term_id=@poster_cat_id;

-- Link product to attribute terms
INSERT INTO wp_term_relationships (object_id, term_taxonomy_id)
SELECT @product_id, term_taxonomy_id FROM wp_term_taxonomy WHERE taxonomy='pa_size';

-- Create A3 variation
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_title, post_status, post_name, post_type, post_parent)
VALUES (1, NOW(), UTC_TIMESTAMP(), 'Custom Poster - A3', 'publish', CONCAT('product-', @product_id, '-a3'), 'product_variation', @product_id);
SET @var_a3 = LAST_INSERT_ID();

-- Create A2 variation  
INSERT INTO wp_posts (post_author, post_date, post_date_gmt, post_title, post_status, post_name, post_type, post_parent)
VALUES (1, NOW(), UTC_TIMESTAMP(), 'Custom Poster - A2', 'publish', CONCAT('product-', @product_id, '-a2'), 'product_variation', @product_id);
SET @var_a2 = LAST_INSERT_ID();

-- Set variation metadata
INSERT INTO wp_postmeta (post_id, meta_key, meta_value) VALUES
(@var_a3, '_sku', 'PDC-POSTER-A3'),
(@var_a3, '_price', '19.99'),
(@var_a3, '_regular_price', '19.99'),
(@var_a3, '_stock_status', 'instock'),
(@var_a3, '_manage_stock', 'no'),
(@var_a3, 'attribute_pa_size', 'a3'),
(@var_a2, '_sku', 'PDC-POSTER-A2'),
(@var_a2, '_price', '34.99'),
(@var_a2, '_regular_price', '34.99'),
(@var_a2, '_stock_status', 'instock'),
(@var_a2, '_manage_stock', 'no'),
(@var_a2, 'attribute_pa_size', 'a2'),
(@product_id, '_price', '19.99'),
(@product_id, '_min_variation_price', '19.99'),
(@product_id, '_max_variation_price', '34.99'),
(@product_id, '_min_variation_regular_price', '19.99'),
(@product_id, '_max_variation_regular_price', '34.99');
"

# Update WooCommerce version and setup completion
echo "üîÑ Finalizing WooCommerce setup..."
execute_sql "
INSERT INTO wp_options (option_name, option_value, autoload) VALUES
('woocommerce_onboarding_profile', '{\"completed\": true}', 'yes')
ON DUPLICATE KEY UPDATE option_value = VALUES(option_value);"

# Flush rewrite rules
echo "üîÑ Flushing rewrite rules..."
docker compose -f config/docker-compose.yml run --rm wpcli wp rewrite flush --allow-root

# Final verification
echo "üîç Verifying WooCommerce setup..."
execute_sql "SELECT COUNT(*) as product_count FROM wp_posts WHERE post_type = 'product' AND post_status = 'publish';"
execute_sql "SELECT p.post_title, pm1.meta_value as sku, pm2.meta_value as price FROM wp_posts p LEFT JOIN wp_postmeta pm1 ON p.ID = pm1.post_id AND pm1.meta_key = '_sku' LEFT JOIN wp_postmeta pm2 ON p.ID = pm2.post_id AND pm2.meta_key = '_price' WHERE p.post_type = 'product' AND p.post_status = 'publish' ORDER BY p.post_title;"

echo "üéâ WooCommerce seeding completed successfully!"