#!/usr/bin/env bash

# Create a clean plugin archive using WP-CLI inside Docker
# Usage: bin/create-dist [WORDPRESS_VERSION] [PHP_VERSION]
# Examples:
#   bin/create-dist            # defaults to 67 82
#   bin/create-dist 67 82

# the cmd dist-archive is not pre-installed on wp-cli containers
# but can be added as a composer package through wp package. Installing
# this requires git (configured to use https urls instead of ssh) & zip as deps
# whole thing is run as www-data to avoid root owned archive
#

set -euo pipefail

CONFIG_FILE="config/wp-version.conf"
WORDPRESS_VERSION_ENV="${1:-${WORDPRESS_VERSION:-67}}"
PHP_VERSION_ENV="${2:-${PHP_VERSION:-82}}"

WORDPRESS_PORT="80${WORDPRESS_VERSION_ENV}"
WP_IMAGE_KEY="${WORDPRESS_VERSION_ENV}_${PHP_VERSION_ENV}"
WP_IMAGE=$(grep "^${WP_IMAGE_KEY}=" "$CONFIG_FILE" | cut -d'=' -f2)

if [ -z "${WP_IMAGE}" ]; then
  echo "Error: No WP image found for key ${WP_IMAGE_KEY} in ${CONFIG_FILE}" >&2
  exit 1
fi

export WP_IMAGE
export COMPOSE_PROJECT_NAME="pdc_${WORDPRESS_VERSION_ENV}_${PHP_VERSION_ENV}"
export WORDPRESS_PORT

export WP_CLI_PACKAGES_DIR="/var/www/.wp-cli-packages"
export WP_CLI_CACHE_DIR="/var/www/.wp-cli-cache"
export COMPOSER_HOME="/var/www/.composer"

echo "Creating distribution archive via WP-CLI in Docker (image=${WP_IMAGE})..."

# 0) cleanup
rm -f pdc-pod.[0-9]*.zip 2>/dev/null || true

# 1) install dependencies zip, git and ca-certs
docker compose -f config/docker-compose.yml run -T --rm --user root \
  -e WP_CLI_PACKAGES_DIR -e WP_CLI_CACHE_DIR -e COMPOSER_HOME \
  wpcli sh -eu -s <<'SH'
apk add --no-cache zip git ca-certificates >/dev/null 2>&1
update-ca-certificates >/dev/null 2>&1 || true

mkdir -p "$WP_CLI_PACKAGES_DIR" "$WP_CLI_CACHE_DIR" "$COMPOSER_HOME/cache/vcs"
chown -R www-data:www-data "$WP_CLI_PACKAGES_DIR" "$WP_CLI_CACHE_DIR" "$COMPOSER_HOME"

# 2) now run the install wp dist-archive cmd
su -s /bin/sh www-data <<'WW'
set -eu
git config --global url.https://github.com/.insteadOf git@github.com:

export WP_CLI_PACKAGES_DIR="$WP_CLI_PACKAGES_DIR"
export WP_CLI_CACHE_DIR="$WP_CLI_CACHE_DIR"
export COMPOSER_HOME="$COMPOSER_HOME"

wp package install wp-cli/dist-archive-command:v3.0.1

# 3) create a temp copy to force filesystem state (avoid git archive)
TMP_DIR=$(mktemp -d)
cp -r /var/www/html/wp-content/plugins/pdc-pod "$TMP_DIR/pdc-pod"
rm -rf "$TMP_DIR/pdc-pod/.git" "$TMP_DIR/pdc-pod/.github"

# 4) create the archive from temp copy, output to plugin dir
wp dist-archive "$TMP_DIR/pdc-pod" "/var/www/html/wp-content/plugins/pdc-pod" --format=zip

rm -rf "$TMP_DIR"
SH

echo "âœ“ Archive created in your plugin directory (host-mapped)."
